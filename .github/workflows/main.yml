---
name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: opensafely-core/setup-action@v1
        with:
          install-just: true
          python-version: "3.9"
      - name: Check formatting, linting and import sorting
        run: just check

  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - uses: opensafely-core/setup-action@v1
        with:
          install-just: true
          python-version: "3.9"
          cache-dependency-path: requirements.*.txt

      - name: Check generated docs are up-to-date
        run: just docs-check-generated-docs-are-current

      - name: Check snippets work
        run: just docs-test

      - name: Check dataset definitions run with Python installed Data Builder
        run: just docs-check-dataset-definitions

      - name: Check dataset definition outputs are up-to-date
        run: just docs-check-dataset-definitions-outputs-are-current

      # This check becomes somewhat redundant if we fix up the Cloudflare Pages preview
      # to work with Dependabot, because the deployment will also do the build.
      # See https://github.com/opensafely/documentation/issues/930 which documents this problem.
      #
      # However, for any PR, Cloudflare Pages previews sometimes fail for mysterious reasons,
      # and this requires logging into Cloudflare Pages to inspect.
      # So it is perhaps useful to distinguish a Cloudflare failure with an actual issue.
      - name: Check docs build
        run: just docs-build

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: opensafely-core/setup-action@v1
        with:
          install-just: true
          python-version: "3.9"
      - name: Run tests
        env:
          CI: 1
        run: just test-all

  lint-dockerfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf
        with:
          failure-threshold: error

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: opensafely-core/setup-action@v1
      with:
        install-just: true
        python-version: "3.9"
    - name: Install package
      run: pip install .

    - name: Build Docker image
      run: just build-databuilder

  tag-new-version:
    # This uses `conventional commits` to generate tags.  A full list
    # of valid prefixes is here:
    # https://github.com/commitizen/conventional-commit-types/blob/master/index.json
    #
    # fix, perf -> patch release
    # feat -> minor release
    # BREAKING CHANGE in footer -> major release
    #
    # anything else (docs, refactor, etc) does not create a release
      needs: [check, test, build, documentation]
      runs-on: ubuntu-latest
      outputs:
        tag: ${{ steps.tag.outputs.new_version }}
      steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0
        - name: Bump version and push tag
          id: tag
          uses: mathieudutour/github-tag-action@981ffb2cc3f2b684b2bfd8ee17bc8d781368ba60
          with:
            github_token: ${{ secrets.TRIGGER_TAG_BUILD_TOKEN }}
            default_bump: false
            release_branches: main
